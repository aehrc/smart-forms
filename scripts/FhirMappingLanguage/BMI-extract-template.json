{
  "resourceType": "Questionnaire",
  "id": "CalculatedExpressionBMICalculatorExtract",
  "meta": {
    "versionId": "5",
    "lastUpdated": "2025-04-03T05:38:31.289+00:00",
    "source": "#8uqrFfye7av67zi1",
    "profile": [
      "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-extr-template",
      "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-observationTemplate"
    ]
  },
  "contained": [
    {
      "resourceType": "Observation",
      "id": "height-obs",
      "status": "final",
      "category": [
        {
          "coding": [
            {
              "system": "http://terminology.hl7.org/CodeSystem/observation-category",
              "code": "vital-signs"
            }
          ]
        }
      ],
      "code": {
        "coding": [
          {
            "system": "http://loinc.org",
            "code": "8302-2",
            "display": "Body height"
          }
        ]
      },
      "subject": {
        "extension": [
          {
            "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-templateExtractValue",
            "valueString": "%QuestionnaireResponse.subject"
          }
        ]
      },
      "effectiveDateTime": "1900-01-01",
      "_effectiveDateTime": {
        "extension": [
          {
            "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-templateExtractValue",
            "valueString": "now()"
          }
        ]
      },
      "valueQuantity": {
        "extension": [
          {
            "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-templateExtractValue",
            "valueString": "item.where(linkId='bmi-calculation').item.where(linkId='patient-height').answer.valueDecimal"
          }
        ],
        "value": 0,
        "unit": "cm",
        "system": "http://unitsofmeasure.org",
        "code": "cm"
      }
    },
    {
      "resourceType": "Observation",
      "id": "weight-obs",
      "status": "final",
      "category": [
        {
          "coding": [
            {
              "system": "http://terminology.hl7.org/CodeSystem/observation-category",
              "code": "vital-signs"
            }
          ]
        }
      ],
      "code": {
        "coding": [
          {
            "system": "http://loinc.org",
            "code": "29463-7",
            "display": "Weight"
          }
        ]
      },
      "subject": {
        "extension": [
          {
            "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-templateExtractValue",
            "valueString": "%QuestionnaireResponse.subject"
          }
        ]
      },
      "effectiveDateTime": "1900-01-01",
      "_effectiveDateTime": {
        "extension": [
          {
            "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-templateExtractValue",
            "valueString": "now()"
          }
        ]
      },
      "valueQuantity": {
        "extension": [
          {
            "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-templateExtractValue",
            "valueString": "item.where(linkId='bmi-calculation').item.where(linkId='patient-weight').answer.valueDecimal"
          }
        ],
        "value": 0,
        "unit": "kg",
        "system": "http://unitsofmeasure.org",
        "code": "kg"
      }
    },
    {
      "resourceType": "Observation",
      "id": "bmi-obs",
      "status": "final",
      "category": [
        {
          "coding": [
            {
              "system": "http://terminology.hl7.org/CodeSystem/observation-category",
              "code": "vital-signs"
            }
          ]
        }
      ],
      "code": {
        "coding": [
          {
            "system": "http://loinc.org",
            "code": "39156-5",
            "display": "Body mass index"
          }
        ]
      },
      "subject": {
        "extension": [
          {
            "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-templateExtractValue",
            "valueString": "%QuestionnaireResponse.subject"
          }
        ]
      },
      "effectiveDateTime": "1900-01-01",
      "_effectiveDateTime": {
        "extension": [
          {
            "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-templateExtractValue",
            "valueString": "now()"
          }
        ]
      },
      "valueQuantity": {
        "extension": [
          {
            "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-templateExtractValue",
            "valueString": "item.where(linkId='bmi-calculation').item.where(linkId='bmi-result').answer.valueQuantity.value"
          }
        ],
        "value": 0,
        "unit": "kg/m2",
        "system": "http://unitsofmeasure.org",
        "code": "kg/m2"
      }
    }
  ],
  "extension": [
    {
      "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-template",
      "valueBoolean": true
    },
    {
      "url": "http://hl7.org/fhir/StructureDefinition/variable",
      "valueExpression": {
        "name": "ObsBodyHeight",
        "language": "application/x-fhir-query",
        "expression": "Observation?code=8302-2&_count=1&_sort=-date&patient={{%patient.id}}"
      }
    },
    {
      "url": "http://hl7.org/fhir/StructureDefinition/variable",
      "valueExpression": {
        "name": "ObsBodyWeight",
        "language": "application/x-fhir-query",
        "expression": "Observation?code=29463-7&_count=1&_sort=-date&patient={{%patient.id}}"
      }
    },
    {
      "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-launchContext",
      "extension": [
        {
          "url": "name",
          "valueCoding": {
            "system": "http://hl7.org/fhir/uv/sdc/CodeSystem/launchContext",
            "code": "patient"
          }
        },
        {
          "url": "type",
          "valueCode": "Patient"
        }
      ]
    }
  ],
  "url": "https://smartforms.csiro.au/docs/sdc/population/calculated-expression-1",
  "version": "0.1.0",
  "name": "CalculatedExpression BMI Calculator - Extraction",
  "title": "CalculatedExpression BMI Calculator - Extraction",
  "status": "draft",
  "date": "2024-05-15",
  "publisher": "AEHRC CSIRO",
  "item": [
    {
      "extension": [
        {
          "url": "http://hl7.org/fhir/StructureDefinition/variable",
          "valueExpression": {
            "name": "height",
            "language": "text/fhirpath",
            "expression": "item.where(linkId='patient-height').answer.value"
          }
        },
        {
          "url": "http://hl7.org/fhir/StructureDefinition/variable",
          "valueExpression": {
            "name": "weight",
            "language": "text/fhirpath",
            "expression": "item.where(linkId='patient-weight').answer.value"
          }
        }
      ],
      "linkId": "bmi-calculation",
      "text": "BMI Calculation",
      "type": "group",
      "repeats": false,
      "item": [
        {
          "extension": [
            {
              "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-initialExpression",
              "valueExpression": {
                "language": "text/fhirpath",
                "expression": "%ObsBodyHeight.entry.resource.value.value"
              }
            },
            {
              "url": "http://hl7.org/fhir/StructureDefinition/questionnaire-unit",
              "valueCoding": {
                "system": "http://unitsofmeasure.org",
                "code": "cm",
                "display": "cm"
              }
            },
            {
              "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-templateExtract",
              "extension": [
                {
                  "url": "template",
                  "valueReference": {
                    "reference": "#height-obs"
                  }
                }
              ]
            }
          ],
          "linkId": "patient-height",
          "text": "Height",
          "type": "decimal",
          "repeats": false,
          "readOnly": false
        },
        {
          "extension": [
            {
              "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-initialExpression",
              "valueExpression": {
                "language": "text/fhirpath",
                "expression": "%ObsBodyWeight.entry.resource.value.value"
              }
            },
            {
              "url": "http://hl7.org/fhir/StructureDefinition/questionnaire-unit",
              "valueCoding": {
                "system": "http://unitsofmeasure.org",
                "code": "kg",
                "display": "kg"
              }
            },
            {
              "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-templateExtract",
              "extension": [
                {
                  "url": "template",
                  "valueReference": {
                    "reference": "#weight-obs"
                  }
                }
              ]
            }
          ],
          "linkId": "patient-weight",
          "text": "Weight",
          "type": "decimal",
          "repeats": false,
          "readOnly": false
        },
        {
          "extension": [
            {
              "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression",
              "valueExpression": {
                "description": "BMI calculation",
                "language": "text/fhirpath",
                "expression": "(%weight/((%height/100).power(2))).round(1)"
              }
            },
            {
              "url": "http://hl7.org/fhir/StructureDefinition/questionnaire-unit",
              "valueCoding": {
                "system": "http://unitsofmeasure.org",
                "code": "kg/m2",
                "display": "kg/m2"
              }
            },
            {
              "url": "http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-templateExtract",
              "extension": [
                {
                  "url": "template",
                  "valueReference": {
                    "reference": "#bmi-obs"
                  }
                }
              ]
            }
          ],
          "linkId": "bmi-result",
          "text": "Value",
          "type": "quantity",
          "repeats": false,
          "readOnly": true,
          "answerOption": [
            {
              "valueCoding": {
                "system": "http://terminology.hl7.org/CodeSystem/quantity-comparator",
                "code": "<",
                "display": "Less than"
              }
            },
            {
              "valueCoding": {
                "system": "http://terminology.hl7.org/CodeSystem/quantity-comparator",
                "code": "<=",
                "display": "Less than or equal to"
              }
            },
            {
              "valueCoding": {
                "system": "http://terminology.hl7.org/CodeSystem/quantity-comparator",
                "code": ">=",
                "display": "Greater than or equal to"
              }
            },
            {
              "valueCoding": {
                "system": "http://terminology.hl7.org/CodeSystem/quantity-comparator",
                "code": ">",
                "display": "Greater than"
              }
            }
          ]
        }
      ]
    }
  ]
} 